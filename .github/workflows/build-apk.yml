name: Build Android APK

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create Android Project
        run: |
          mkdir -p android-app/app/src/main/java/com/flixnest/app
          mkdir -p android-app/app/src/main/res/values
          mkdir -p android-app/app/src/main/res/layout
          mkdir -p android-app/app/src/main/res/mipmap-xxxhdpi
          mkdir -p android-app/gradle/wrapper

      - name: Create Gradle files
        run: |
          cat > android-app/settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = 'Flixnest'
          include ':app'
          EOF

          cat > android-app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application' version '8.2.0' apply false
          }
          EOF

          cat > android-app/app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
          }

          android {
              namespace 'com.flixnest.app'
              compileSdk 34

              defaultConfig {
                  applicationId "com.flixnest.app"
                  minSdk 24
                  targetSdk 34
                  versionCode System.getenv("RUN_NUMBER")?.toInteger() ?: 1
                  versionName "1.0.${System.getenv("RUN_NUMBER") ?: '0'}"
              }

              signingConfigs {
                  release {
                      storeFile file('keystore.jks')
                      storePassword System.getenv("KEYSTORE_PASSWORD") ?: "flixnest123"
                      keyAlias "flixnest"
                      keyPassword System.getenv("KEYSTORE_PASSWORD") ?: "flixnest123"
                  }
              }

              buildTypes {
                  release {
                      minifyEnabled true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt')
                      signingConfig signingConfigs.release
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }

          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'androidx.webkit:webkit:1.8.0'
          }
          EOF

          cat > android-app/gradle.properties << 'EOF'
          android.useAndroidX=true
          org.gradle.jvmargs=-Xmx2048m
          EOF

          cat > android-app/gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
          EOF

      - name: Create Android resources
        run: |
          cat > android-app/app/src/main/res/values/strings.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">Flixnest</string>
          </resources>
          EOF

          cat > android-app/app/src/main/res/values/colors.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <color name="background">#09090b</color>
              <color name="primary">#DC2626</color>
          </resources>
          EOF

          cat > android-app/app/src/main/res/values/themes.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <style name="AppTheme" parent="Theme.AppCompat.DayNight.NoActionBar">
                  <item name="android:statusBarColor">@color/background</item>
                  <item name="android:navigationBarColor">@color/background</item>
                  <item name="android:windowBackground">@color/background</item>
              </style>
          </resources>
          EOF

          cat > android-app/app/src/main/res/layout/activity_main.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <WebView xmlns:android="http://schemas.android.com/apk/res/android"
              android:id="@+id/webview"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:background="#09090b" />
          EOF

      - name: Create AndroidManifest
        run: |
          cat > android-app/app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:label="@string/app_name"
                  android:theme="@style/AppTheme"
                  android:usesCleartextTraffic="true"
                  android:hardwareAccelerated="true">

                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:configChanges="orientation|screenSize|keyboard|keyboardHidden"
                      android:screenOrientation="portrait">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      - name: Create MainActivity
        run: |
          cat > android-app/app/src/main/java/com/flixnest/app/MainActivity.java << 'EOF'
          package com.flixnest.app;

          import android.os.Bundle;
          import android.webkit.*;
          import android.content.Intent;
          import android.net.Uri;
          import android.view.View;
          import android.view.WindowManager;
          import android.graphics.Color;
          import androidx.appcompat.app.AppCompatActivity;

          public class MainActivity extends AppCompatActivity {
              private WebView webView;
              private static final String URL = "https://flixnest.vercel.app";

              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);

                  getWindow().setFlags(
                      WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS,
                      WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS
                  );
                  getWindow().getDecorView().setSystemUiVisibility(
                      View.SYSTEM_UI_FLAG_LAYOUT_STABLE | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                  );

                  setContentView(R.layout.activity_main);

                  webView = findViewById(R.id.webview);
                  setupWebView();
                  webView.loadUrl(URL);
              }

              private void setupWebView() {
                  WebSettings settings = webView.getSettings();
                  settings.setJavaScriptEnabled(true);
                  settings.setDomStorageEnabled(true);
                  settings.setAllowFileAccess(true);
                  settings.setMediaPlaybackRequiresUserGesture(false);
                  settings.setCacheMode(WebSettings.LOAD_DEFAULT);
                  settings.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);
                  settings.setUseWideViewPort(true);
                  settings.setLoadWithOverviewMode(true);
                  settings.setSupportZoom(false);

                  webView.setWebViewClient(new WebViewClient() {
                      @Override
                      public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
                          String url = request.getUrl().toString();

                          // Handle external player intents
                          if (url.startsWith("intent:") || url.startsWith("vlc:") ||
                              url.startsWith("infuse:") || url.startsWith("outplayer:")) {
                              try {
                                  Intent intent = Intent.parseUri(url, Intent.URI_INTENT_SCHEME);
                                  if (intent != null) {
                                      startActivity(intent);
                                      return true;
                                  }
                              } catch (Exception e) {
                                  // If app not installed, try Play Store
                                  try {
                                      Intent intent = Intent.parseUri(url, Intent.URI_INTENT_SCHEME);
                                      String packageName = intent.getPackage();
                                      if (packageName != null) {
                                          startActivity(new Intent(Intent.ACTION_VIEW,
                                              Uri.parse("market://details?id=" + packageName)));
                                          return true;
                                      }
                                  } catch (Exception ignored) {}
                              }
                              return true;
                          }

                          // Handle blob URLs for downloads
                          if (url.startsWith("blob:")) {
                              return false;
                          }

                          return false;
                      }
                  });

                  webView.setWebChromeClient(new WebChromeClient());

                  webView.setDownloadListener((url, userAgent, contentDisposition, mimeType, contentLength) -> {
                      Intent intent = new Intent(Intent.ACTION_VIEW);
                      intent.setData(Uri.parse(url));
                      startActivity(intent);
                  });
              }

              @Override
              public void onBackPressed() {
                  if (webView.canGoBack()) {
                      webView.goBack();
                  } else {
                      super.onBackPressed();
                  }
              }
          }
          EOF

      - name: Download app icon
        run: |
          # Try to download icon, or create a placeholder
          if ! curl -L "https://flixnest.vercel.app/icon-192.png" -o android-app/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png 2>/dev/null; then
            if ! curl -L "https://via.placeholder.com/192/DC2626/FFFFFF?text=F" -o android-app/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png 2>/dev/null; then
              cat << 'EOF' | base64 -d > android-app/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
              iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR4nGP4z8DwHwAF
              gwJ/lN7GngAAAABJRU5ErkJggg==
              EOF
            fi
          fi

      - name: Generate Keystore
        run: |
          cd android-app/app
          keytool -genkey -v -keystore keystore.jks -keyalg RSA -keysize 2048 -validity 10000 \
            -alias flixnest \
            -storepass flixnest123 \
            -keypass flixnest123 \
            -dname "CN=Flixnest, OU=Dev, O=Flixnest, L=Unknown, ST=Unknown, C=US"

      - name: Build APK
        env:
          RUN_NUMBER: ${{ github.run_number }}
          KEYSTORE_PASSWORD: flixnest123
        run: |
          cd android-app
          gradle wrapper --gradle-version 8.2
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Find and rename APK
        run: |
          find android-app -name "*.apk" -type f | head -1 | xargs -I {} cp {} flixnest-v1.0.${{ github.run_number }}.apk
          ls -la *.apk || echo "No APK found"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: flixnest-apk-v1.0.${{ github.run_number }}
          path: flixnest-v1.0.${{ github.run_number }}.apk
          if-no-files-found: error

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Flixnest v1.0.${{ github.run_number }}
          body: |
            ## Flixnest Android App

            Automatikus build a `main` branch-ből.

            ### Telepítés
            1. Töltsd le az APK fájlt
            2. Engedélyezd az "Ismeretlen forrásból történő telepítést" a telefonodon
            3. Telepítsd az APK-t

            ### Változások
            Commit: `${{ github.sha }}`
          files: flixnest-v1.0.${{ github.run_number }}.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
